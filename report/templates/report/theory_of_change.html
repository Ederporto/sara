{% load i18n %}

<div class="w3-container">
    <h3 id="Theory of Change">{% translate "Theory of Change" %}</h3>
    <div class="w3-container formfield">
        <h4 class="formfieldtitle">{% translate "Strategic learning questions related to the activity being reported" %}*</h4>
        <fieldset class="subcontainer">
            <legend>{% translate "Strategic learning questions related to the activity being reported" %}</legend>
            {% for learning_area in report_form.fields.learning_questions_related.choices %}
                <div class="w3-container formfieldtitle">{{ learning_area.0 }}</div>
                {% for learning_question in learning_area.1 %}
                    <label class="container">{{ learning_question.1 }}
                        <input type="checkbox" name="learning_questions_related" data-learning-area="{{ learning_area.0 }}" onclick="show_objectives(this)" value="{{ learning_question.0 }}" {% if learning_question.0 in learning_questions_related_set %}checked{% endif %}>
                        <span class="checkmark"></span>
                    </label>
                {% endfor %}
            {% endfor %}
        </fieldset>

        <h4 class="formfieldtitle">{% translate "Evaluation objectives" %}*</h4>
        <div class="w3-container" id="evaluation_objectives">
            {% for learning_area in report_form.fields.learning_questions_related.choices %}
                <div class="w3-container formfieldtitle" id="objectives_from_learning_area_{{ learning_area.0 }}">{{ learning_area.0 }}</div>
                <div class="w3-container formfield" id="learning_area_{{ learning_area.0 }}"></div>
            {% endfor %}
        </div>
    </div>
    <div class="w3-row">
        <div class="w3-half formfield form-left">
            <button type="button" class="tablinks custombutton"
                    onclick="openTab(this, 'Learning')">{% translate "Go back to learning report" %}</button>
        </div>
        <div class="w3-half formfield form-right">
            <button class="custombutton" type="submit">{% translate "Submit" %}</button>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $('input[name=learning_questions_related]').each(function(){
                if (this.checked) {
                    show_objectives(this);
                }
            })
        });

        function show_objectives(selectObject) {
            let question_id = $(selectObject).val();
            let learning_area_id = $(selectObject).data("learning-area");
            let is_checked = $(selectObject).is(":checked");
            let report_id = "{{ report_form.instance.id }}";
            $.ajax({
            url: '{% url "report:get_objectives" %}',
            datatype: 'json',
            type: 'GET',
            data: {'question_id': question_id, 'report_id': report_id},
            success: function (data) {
                $.each(data.answers, function (index, item) {
                    let n = $("input[data-learning-area='" + learning_area_id + "']:checked").length;
                    let answer_id = item[0];
                    let answer_value = item[1];
                    if (!item[0]){ answer_id=""; answer_value=""; }
                    if (is_checked) {
                        if (n === 1) {
                            let objective_obj = "<div class='w3-container formfield'  data-learning-area='" +
                            learning_area_id + "' id='objective_" + item[2] + "'>" +
                            "<label for='objective_answer_" + item[2] + "'>" + item[3] + "</label>" +
                            "<input id='objective_answer_" + item[2] + "' name='objective_answer_" + item[2] +
                            "' type='text' maxlength='420' data-answer-id='" + answer_id + "' value='" + answer_value + "'/>" + "</div>";
                            $(`[id="learning_area_${learning_area_id}"]`).append(objective_obj);
                        }
                    } else {
                        if (n === 0) {
                            $("#objective_" + item[2]).remove();
                        }
                    }
                })
            }})
        }
    </script>
</div>